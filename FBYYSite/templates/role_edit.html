{% extends "base.html" %}
{% block script %}
<script>

  function addfunction(){
    var modulecode = $("#selrolemodule").val();
    var functioncode = $("#selrolefunction").val();
    if(modulecode===''|| functioncode===''){
    }else{
      if(!isExistOption("id_selrolemodulelist",modulecode)){
        var modulename = $("#selrolemodule option:selected").text()
        addOptionValue("id_selrolemodulelist",modulecode,modulename)
      }
      if(!isExistOption("id_selrolefunctionlist",functioncode)){
        var functionname = $("#selrolefunction option:selected").text()
        addOptionValue("id_selrolefunctionlist",functioncode,functionname)
      }
    }
  }
  function isExistOption(id,value) {
    var isExist = false;
    var count = $("#"+id).find('option').length;
      for(var i=0;i<count;i++)
      {
         if($('#'+id).get(0).options[i].value == value)
             {
                   isExist = true;
                        break;
                  }
        }
        return isExist;
}
function addOptionValue(id,value,text) {
    if(!isExistOption(id,value)){$('#'+id).append("<option value="+value+">"+text+"</option>");}
}
function delOptionValue(id,value) {
    if(isExistOption(id,value)){$("#"+id+" option[value="+value+"]").remove();}
}
function removemodule(){
  var selarr = $("#id_selrolemodulelist").find('option:selected')
  $.each(selarr,function(i,item){
      $.ajax({
          url: '/fbyysite/permission/ajaxfunctions',
          data: {
          'module_code': item.value
        },
          type: 'GET',
       dataType: 'json',
          success: function (data) {
            $.each($.parseJSON(data), function(i, item){
                           delOptionValue("id_selrolefunctionlist",item.fields.tb_function_code)
                });
        },
      });
      delOptionValue("id_selrolemodulelist",item.value)
  });

}
function removefunction(){
  var selarr = $("#id_selrolefunctionlist").find('option:selected')
  $.each(selarr,function(i,item){
      delOptionValue("id_selrolefunctionlist",item.value)
  });
  modulecheck()
}
function modulecheck(){
  var optionarr = $("#id_selrolemodulelist").find('option')
  $.each(optionarr,function(i,moduleitem){

      $.ajax({
          url: '/fbyysite/permission/ajaxfunctions',
          data: {
          'module_code': moduleitem.value
        },
          type: 'GET',
       dataType: 'json',
          success: function (data) {
                  var delflag = true
            $.each($.parseJSON(data), function(j, funcitem){
                            if(isExistOption("id_selrolefunctionlist",funcitem.fields.tb_function_code)){
                             delflag=false
                            }
                });
                  if(delflag){
                    delOptionValue("id_selrolemodulelist",moduleitem.value)
                  }
        },
      });
  });
}
function listselectall(){
   var optionarr = $("#id_selrolemodulelist").find('option')
   $.each(optionarr,function(i,moduleitem){
      moduleitem.selected = true;
  });
  var optionarr = $("#id_selrolefunctionlist").find('option')
   $.each(optionarr,function(j,funcitem){
      funcitem.selected = true;
      $("#editroleform").submit()
  });
}

</script>
{% endblock %}
{% block content %}
<div class="jumbotron text-center" style="margin-bottom:0">
  <h1>修改角色信息</h1>
</div>
<div class="container" style="margin-top:100px; width:40em;">
 <form action="/fbyysite/rolemanage/roleeditcheck" method="post" id="editroleform">
    <!-- {% csrf_token %} -->
     <div class="form-group">
      <input type="hidden" name="roleid"  value="{{role.idtb_role}}">
    </div>
     <div class="form-group">
      <input type="hidden" name="refererurl"  value="{{refererurl}}">
    </div>
    <div class="form-group">
        {{ form.rolecode.errors }}
      <label for="id_rolecode">角色编码:</label>
      <input type="text" name="rolecode" placeholder="请输入真实姓名" class="form-control" maxlength="20" required="" id="id_rolecode" value="{{role.tb_role_code}}">
    </div>
    <div class="form-group">
        {{ form.rolename.errors }}
      <label for="id_rolename">角色名称:</label>
      <input type="text" name="rolename" placeholder="请输入公司内部花名" class="form-control" maxlength="20" required="" id="id_rolename" value="{{role.tb_role_name}}">
    </div>
    <div class="d-flex flex-row">
          <div class="form-group form-inline">
      <label for="selrolemodule">模块:</label>&nbsp;&nbsp;
      <select class="form-control" id="selrolemodule">
        <option value=''>请选择模块</option>
        {% for module in modules %}
        <option value={{ module.tb_module_code }}>{{ module.tb_module_name }}</option>
        {% endfor %}
      </select>
      </div>&nbsp;&nbsp;
        <div class="form-group form-inline">
      <label for="selrolefunction">功能:</label>&nbsp;&nbsp;
      <select class="form-control" id="selrolefunction">
      </select>
        </div>&nbsp;&nbsp;
          <div class="form-group form-inline">
            <button type="button" id="btn_addfunction"  onclick="addfunction()" class="btn btn-success text-white btn-sm" ><i class="fa fa-plus-circle fa-sm"></i></button>
          </div>
        </div>
     <div class="form-group">
        <label for="id_selrolemodulelist">模块列表:</label><br>
          <div class="form-inline">
              <select name="selrolemodulelist" id="id_selrolemodulelist"  style="min-width:200px" class="form-control" multiple>
                    {% for module in modules %}
                        {% if module.tb_module_code in role.tb_role_module_list %}
                        <option value={{ module.tb_module_code }}>{{ module.tb_module_name }}</option>
                        {% endif %}
                    {% endfor %}
              </select>&nbsp;&nbsp;&nbsp;&nbsp;
        <button type="button" id="btn_removemodule" onclick="removemodule()" class="btn btn-danger text-white btn-sm" ><i class="fa fa-minus-circle fa-sm"></i></button>

          </div>
        </div>&nbsp;&nbsp;
      <div class="form-group">
      <label for="id_selrolefunctionlist">功能列表:</label><br>
        <div class="form-inline">
            <select name="selrolefunctionlist" id="id_selrolefunctionlist"  style="min-width:200px" class="form-control" multiple>
                {% for functionitem in functionlist %}
                    {% if functionitem.tb_function_code in role.tb_role_function_list %}
                        <option value={{ functionitem.tb_function_code }}>{{ functionitem.tb_function_name }}</option>
                    {% endif %}
                {% endfor %}
            </select>&nbsp;&nbsp;&nbsp;&nbsp;
        <button type="button" id="btn_removefunction" onclick="removefunction()" class="btn btn-danger text-white btn-sm" ><i class="fa fa-minus-circle fa-sm"></i></button>

        </div>
      </div>
    <button type="button" class="btn btn-primary" onclick="listselectall()" >确认修改</button>
    <a href="{{refererurl}}" class="btn btn-secondary" role="button">取消修改</a>
  </form>
    <script>
  $(".errorlist").addClass("list-group")
  $(".errorlist li").addClass("list-group-item-danger")
$(".list-group").removeClass("errorlist")

  var module_code = $("#selrolemodule").val();
if(module_code===''){
$('#selrolefunction').empty();
}else{
      $.ajax({
        url: 'permission/ajaxfunctions',
        data: {
          'module_code': module_code
        },
        type: 'GET',
        dataType: 'json',
        success: function (data) {
                  $('#selrolefunction').empty();
            var content='';
            $.each($.parseJSON(data), function(i, item){
                  content+='<option value='+item.fields.tb_function_code+'>'+item.fields.tb_function_name+'</option>'
                });
            $('#selrolefunction').html(content)
        },
      });
}
$("#selrolemodule").change(function() {
      var module_code = $(this).val();
        if(module_code===''){
            $('#selrolefunction').empty();
        }else{
        $.ajax({
        url: '/fbyysite/permission/ajaxfunctions',
        data: {
          'module_code': module_code
        },
        type: 'GET',
        dataType: 'json',
        success: function (data) {
                  $('#selrolefunction').empty();
            var content='';
            $.each($.parseJSON(data), function(i, item){
                  content+='<option value='+item.fields.tb_function_code+'>'+item.fields.tb_function_name+'</option>'
                });
            $('#selrolefunction').html(content)
        },
      });
        }  
    });

</script>
</div>
{% endblock %}