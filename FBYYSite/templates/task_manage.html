{% extends "base.html" %}
{% block style %}
<style type="text/css">
 tr td{
		/* 不换行*/
		word-break:keep-all;
		/* 不换行*/
		white-space:nowrap;
		text-overflow: ellipsis;
		height:63px;
	}
        </style>
{% endblock %}
{% block script %}
<script>
    $(document).ready(function(){
 $("#fixbody tr").hover(function(){
    var num = $("#fixbody tr").index(this)
    $("#fixbody tr").eq(num).css("background-color","#e9ecef");
    $("#unfixbody tr").eq(num).css("background-color","#e9ecef");
    },function(){
     var num = $("#fixbody tr").index(this)
     $("#fixbody tr").eq(num).css("background-color","white");
    $("#unfixbody tr").eq(num).css("background-color","white");
  });
  $("#unfixbody tr").hover(function(){
    var num = $("#unfixbody tr").index(this)
    $("#fixbody tr").eq(num).css("background-color","#e9ecef");
    $("#unfixbody tr").eq(num).css("background-color","#e9ecef");
    },function(){
     var num = $("#unfixbody tr").index(this)
     $("#fixbody tr").eq(num).css("background-color","white");
    $("#unfixbody tr").eq(num).css("background-color","white");
  });
  $('#openModal').on('show.bs.modal', function (event) {
       $('#ResultFrame').attr('src', '').on('load',function(){
    });
    })
});
 function cancelconfirm(obj){
        var tr = $(obj).parent().parent().parent();
        var taskid = tr.children("td:nth-child(1)").text();
        var taskname = tr.children("td:nth-child(2)").text();
        var taskuploadname = tr.children("td:nth-child(3)").text();
        var taskstatus = tr.children("td:nth-child(4)").text();
        var taskcreatetime = tr.children("td:nth-child(5)").text();
        $("#canceltaskname").text(taskname);
        $("#canceltaskuploadname").text(taskuploadname);
        $("#canceltaskcurstatus").text(taskstatus);
        $("#canceltaskcreatetime").text(taskcreatetime);
        $("#canceltaskid").val(taskid);
        $("#canceltaskreferer").val(window.location.href);
    }
</script>
{% endblock %}
{% block content %}
<body>
    <div class="container-fluid d-inline-flex d-flex justify-content-between">
        <div class="p-2">
            <h2>任务信息列表</h2>
        </div>

        <div class="btn-group p-3 text-center">
            <button class="btn btn-success text-white ml-auto" type="button" data-toggle="modal" data-target="#openModal" ><i class="fa fa-rocket fa-lg"></i>开启后台任务服务</button>
            <a class="btn btn-info text-white ml-auto" href="/fbyysite/taskmanage/visualshow/{{userid}}"><i class="bar-chart fa-lg"></i>查看任务统计</a>
        </div>

    </div>
    <hr>
    {% if queryform.errors %}
        <div class="container-fluid alert alert-warning">
            <button type="button" class="close" data-dismiss="alert">&times;</button>
            <strong>请修改以下错误</strong>
        </div>
    {% endif %}
    <form id="id_queryform" action="/fbyysite/taskmanage/query/1" method="post" class="form-inline">
        <div class="form-group p-2 m-2">
            <label for="id_taskid">任务ID:&nbsp;&nbsp;</label>
            {{ queryform.taskid }}
        </div>
        &nbsp;&nbsp;{{ queryform.taskid.errors }}&nbsp;&nbsp;
        <div class="form-group p-2 m-2">
            <label for="id_taskuploadfilename">任务上传文件名称:&nbsp;&nbsp;</label>
            {{ queryform.taskuploadfilename }}
        </div>

        &nbsp;&nbsp;{{ queryform.taskuploadfilename.errors }}&nbsp;&nbsp;
        <div class="form-group p-2 m-2">
            <label for="seltaskstatus">任务状态:&nbsp;&nbsp;</label>
            <select class="form-control" id="seltaskstatus" name="seltaskstatus">
                <option value=''>请选择</option>
                <option value='任务未完成'>任务未完成</option>
                <option value='任务进行中'>任务进行中</option>
                <option value='任务已完成'>任务已完成</option>
                <option value='任务已取消'>任务已取消</option>
                <option value='任务已失败'>任务已失败</option>
                <option value='文件已过期'>任务已过期</option>
            </select>
        </div>
        <div class="form-group p-2 m-2">
            <label for="id_taskcreatedate">创建日期:&nbsp;&nbsp;</label>
            <div class="input-group ">
                <div class="input-group-prepend">
                    <div class="input-group-text">
                      {{ queryform.taskcreatedatewhetherflag }}
                    </div>
                </div>
            {{queryform.taskcreatedate}}
            </div>
            &nbsp;&nbsp;{{ queryform.taskcreatedate.errors }}&nbsp;&nbsp;
        </div>
        <div class="form-group p-2 m-2">
            <label for="id_taskexpiredate">过期日期:&nbsp;&nbsp;</label>
            <div class="input-group ">
                <div class="input-group-prepend">
                    <div class="input-group-text">
                      {{ queryform.taskexpiredateewhetherflag }}
                    </div>
                </div>
            {{queryform.taskexpiredate}}
            </div>
            &nbsp;&nbsp;{{ queryform.taskexpiredate.errors }}&nbsp;&nbsp;
        </div>
        <div class="form-group p-2 m-2">
            <label for="id_taskexpiredate">取消日期:&nbsp;&nbsp;</label>
            <div class="input-group ">
                <div class="input-group-prepend">
                    <div class="input-group-text">
                      {{ queryform.taskcanceldatewhetherflag }}
                    </div>
                </div>
            {{queryform.taskcanceldate}}
            </div>
            &nbsp;&nbsp;{{ queryform.taskcanceldate.errors }}&nbsp;&nbsp;
        </div>
        <div class="form-group p-2 m-2">
            <label for="id_taskexpiredate">开始日期:&nbsp;&nbsp;</label>
            <div class="input-group ">
                <div class="input-group-prepend">
                    <div class="input-group-text">
                      {{ queryform.taskstartdateewhetherflag }}
                    </div>
                </div>
            {{queryform.taskstartdate}}
            </div>
            &nbsp;&nbsp;{{ queryform.taskstartdate.errors }}&nbsp;&nbsp;
        </div>
        <div class="form-group p-2 m-2">
            <label for="id_taskexpiredate">结束日期:&nbsp;&nbsp;</label>
            <div class="input-group ">
                <div class="input-group-prepend">
                    <div class="input-group-text">
                      {{ queryform.taskenddateewhetherflag }}
                    </div>
                </div>
            {{queryform.taskenddate}}
            </div>
            &nbsp;&nbsp;{{ queryform.taskenddate.errors }}&nbsp;&nbsp;
        </div>
        <div class="btn-group">
            <button id="btnquery" type="submit" class="btn btn-primary"><i class="fa fa-search fa-lg"></i>查询</button>
            <button type="reset" class="btn btn-secondary"><i class="fa fa-remove fa-lg"></i>重置</button>
            <a class="btn btn-info" href="/fbyysite/taskmanage/pagenum/1"><i class="fa fa-user-circle fa-lg"></i>显示全部数据</a>
        </div>
    </form>
    <script>
  $(".errorlist").addClass("list-group")
  $(".errorlist li").addClass("list-group-item-danger")
</script>
    <hr/>
    {% if alltasklist %}
    <div class="d-inline-flex table-responsive" style="width:100%;height:100%;position: relative;">
        <table  class="table" style="width:60%;height:100%;">
            <thead class="thead-light" style="white-space:nowrap;">
                <tr>
                    <th >任务ID</th>
                    <th >任务名称</th>
                    <th >用户花名</th>
                    <th >任务上传文件名</th>
                    <th >任务存储文件名</th>
                </tr>
            </thead>
            <tbody id="fixbody">
            {% for task in alltasklist %}
            <tr >
                <td >{{task.idtb_task_info}}</td>
                <td>{{task.tb_task_info_name}}</td>
                <td>{{task.tb_task_info_content.taskusernickname}}</td>
                <td>{{task.tb_task_info_content.fileuploadname}}</td>
                <td>{{task.tb_task_info_content.savepathname}}</td>

            </tr>
            {% endfor %}
            </tbody>
        </table>
        <table class="table " style="position: absolute;overflow-x:scroll;overflow-y:hidden;left:60%;display:block;width:40%;height:100%;">
            <thead class="thead-light" style="white-space:nowrap;">
                <tr >
                    <th >任务状态</th>
                    <th >任务创建时间</th>
                    <th >任务取消时间</th>
                    <th >任务开始时间</th>
                    <th >任务结束时间</th>
                    <th >任务过期日期</th>
                    <th >操作</th>
                </tr>
            </thead>
            <tbody id="unfixbody">
            {% for task in alltasklist %}
            <tr >
                <td>{{task.tb_task_info_status}}</td>
                <td>{{task.tb_task_info_createtime}}</td>
                <td>{{task.tb_task_info_canceltime}}</td>
                <td>{{task.tb_task_info_starttime}}</td>
                <td>{{task.tb_task_info_endtime}}</td>
                <td>{{task.tb_task_info_expire_date}}</td>
                <td>
                    {% ifequal task.tb_task_info_status "任务未完成"%}
                    <div class="btn-group">
                        <button type="button" class="btn btn-danger text-white" onclick="cancelconfirm(this)" data-toggle="modal" data-target="#cancelModal"><i class="fa fa-ban fa-lg"></i>取消任务</button>
                    </div>
                    {% else %}
                    <div class="btn-group">
                        <button type="button" class="btn btn-danger text-white disabled"  ><i class="fa fa-ban fa-lg"></i>无法取消</button>
                    </div>
                    {% endifequal %}
                </td>
            </tr>
            {% endfor %}

            </tbody>
        </table>

    </div>
    {% block pageination %}

        <div class="d-inline-flex p-3 container-fluid">
                <ul class="pagination">
                    {% if alltasklist.has_previous %}
                    <li class="page-item"><a class="page-link" href="/fbyysite/taskmanage/pagenum/1">首页</a></li>
                    <li class="page-item"><a class="page-link" href="/fbyysite/taskmanage/pagenum/{{alltasklist.previous_page_number}}">上一页</a></li>
                    {% else %}
                    <li class="page-item disabled"><a class="page-link" href="#">首页</a></li>
                    <li class="page-item disabled"><a class="page-link" href="#">上一页</a></li>
                    {% endif %}
                    <li class="page-item active"><a class="page-link" href="/fbyysite/taskmanage/pagenum/{{currentpage}}">{{currentpage}}</a></li>
                    {% if alltasklist.has_next %}
                    <li class="page-item"><a class="page-link" href="/fbyysite/taskmanage/pagenum/{{alltasklist.next_page_number}}">下一页</a></li>
                    <li class="page-item"><a class="page-link" href="/fbyysite/taskmanage/pagenum/{{totalpages}}">尾页</a></li>
                    {% else %}
                    <li class="page-item disabled"><a class="page-link" href="#">下一页</a></li>
                    <li class="page-item disabled"><a class="page-link" href="#">尾页</a></li>
                    {% endif %}
                    <li class="page-item"><input id="pagenumber" type="number" class="form-control"  min="1" max="{{totalpages}}" value="{{currentpage}}" onkeyup="if(this.value>{{totalpages}}){this.value=''}else{if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}}" onafterpaste="if(this.value>{{totalpages}}){this.value=''}else{if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}}"></li>
                    <li class="page-item"><button type="button" class="btn" id="btnjumppage">跳转</button></li>
                    <li class="page-item">
                            <span class="form-control alert-success" >当前结果共有{{totalpages}}页</span>
                    </li>
                </ul>
        </div>
        <script>
            $("#btnjumppage").on('click',function(){
                var jumppagenum = $("#pagenumber").val();
                if(jumppagenum===''){
                }else{
                    window.location.href="/fbyysite/taskmanage/pagenum/" + jumppagenum;
                }
             });
        </script>
        {% endblock %}
    {% else %}
    <div class="alert alert-danger w-100">
        {% block emptymsg %}<strong>当前还没有任何数据</strong>{% endblock %}
    </div>
    <div class="d-inline-flex" style="width:100%;height:100%;position: relative;">

        <table class="table table-hover " style="width:60%;height:100%;">
            <thead class="thead-light" style="white-space:nowrap;">
                <tr>
                    <th >任务ID</th>
                    <th >任务名称</th>
                    <th >用户花名</th>
                    <th >任务上传文件名</th>
                    <th >任务存储文件名</th>
                </tr>
            </thead>

        </table>


        <table class="table table-hover " style="position: absolute;overflow-x:scroll;left:60%;display:block;width:40%;height:100%;">
            <thead class="thead-light" style="white-space:nowrap;">
                <tr class="" style="white-space:nowrap;">
                    <th >任务状态</th>
                    <th >任务创建时间</th>
                    <th >任务取消时间</th>
                    <th >任务开始时间</th>
                    <th >任务结束时间</th>
                    <th >任务过期日期</th>
                    <th >操作</th>
                </tr>
            </thead>

        </table>

    </div>
    {% endif %}

    <div class="modal fade" id="cancelModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <!-- 模态框头部 -->
        <div class="modal-header">
          <h4 class="modal-title">取消任务提示</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <!-- 模态框主体 -->
        <div class="modal-body">
            <div class="container">
                <p class="text-center text-justify">
                    确定要取消当前任务吗？<br>
                    任务名称为：<strong id="canceltaskname" class="text-danger"></strong><br>
                    任务上传文件名为：<strong id="canceltaskuploadname" class="text-danger"></strong><br>
                    任务当前状态为：<strong id="canceltaskcurstatus" class="text-danger"></strong><br>
                    任务创建时间为：<strong id="canceltaskcreatetime" class="text-danger"></strong><br>
                </p>
            </div>
        </div>

        <!-- 模态框底部 -->
        <div class="modal-footer">
            <form action="/fbyysite/taskmanage/taskcancel" method="post">
                <input type="hidden" id="canceltaskid" name="canceltaskid">
                <input type="hidden" id="canceltaskreferer" name="canceltaskreferer">
                <button type="submit" id="cancelconfirm"  class="btn btn-danger text-white" >确认取消</button>
            </form>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
        </div>

      </div>
    </div>
  </div>
<div class="modal fade" id="openModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <!-- 模态框头部 -->
        <div class="modal-header">
          <h4 class="modal-title">开启后台任务</h4>
          <button type="button" class="close" data-dismiss="modal" id="modalclose">&times;</button>
        </div>
        <!-- 模态框主体 -->
        <div class="modal-body">
            <div class="container">
                    <p class="text-center text-justify">
                    开启后台任务吗？
                    </p>
                    <div class="btn-group pull-right">
                        <a href="/fbyysite/taskmanage/openbgtaskservice" class="btn btn-primary text-white ml-auto pull-right" id="openbackground" target="ResultFrame">开启</a>
                        <button type="button" class="btn btn-secondary ml-auto pull-right" data-dismiss="modal">关闭</button>
                    </div>
            </div>

        </div>
        <div class="modal-footer p-0">
            <iframe name="ResultFrame" id="ResultFrame"  width="100%" height="51px" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" class="p-0">

            </iframe>
        </div>


      </div>
    </div>
  </div>
</body>
{% endblock %}